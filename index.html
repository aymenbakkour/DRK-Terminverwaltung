<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>DRK Terminverwaltung — Modern</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f3f6f9;
      --card:#ffffff;
      --muted:#6b7280;
      --accent:#b91c1c;
      --accent-2:#0078D4;
      --glass: rgba(255,255,255,0.6);
      --shadow: 0 6px 20px rgba(18,38,63,0.08);
      --radius:12px;
      --glass-border: rgba(255,255,255,0.6);
      --success:#10b981;
      --danger:#ef4444;
      --max-width:1100px;
      --gap:16px;
      --transition:200ms cubic-bezier(.2,.9,.3,1);
      --mono: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    /* UPDATED: Full white background, no gradients, no padding on body */
    body{
      font-family:var(--mono);
      margin:0;
      background: #ffffff; 
      color:#0f172a;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      display:flex;
      justify-content:center;
      align-items: center; /* Center content vertically and horizontally for login screen */
    }

    .wrap{
      width:100%;
      max-width:var(--max-width);
      display:flex;
      gap:var(--gap);
      align-items:flex-start;
      padding:28px; /* Added padding here for the main app content */
    }
    
    /* left column */
    .panel{
      flex:1 1 680px;
      background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(250,250,250,0.9));
      border-radius:var(--radius);
      padding:20px;
      box-shadow:var(--shadow);
      border:1px solid rgba(15,23,42,0.04);
      backdrop-filter: blur(6px) saturate(120%);
    }

    header.app-header{
      display:flex;
      gap:12px;
      align-items:center;
      margin-bottom:18px;
    }
    .logo{
      width:64px;height:64px;border-radius:12px;
      background: linear-gradient(135deg,var(--accent),var(--accent-2));
      display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:20px;
      box-shadow: 0 8px 24px rgba(7,89,133,0.12), inset 0 -6px 18px rgba(255,255,255,0.06);
    }
    .title{
      display:flex;flex-direction:column;
    }
    .title h1{font-size:20px;margin:0;color:#07142a}
    .title p{margin:2px 0 0 0;color:var(--muted);font-size:13px}

    .controls{
      display:flex;
      gap:10px;
      margin:12px 0 18px 0;
      flex-wrap:wrap;
    }
    .btn{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 14px;border-radius:10px;border:0;cursor:pointer;
      transition:all var(--transition);
      font-weight:600;font-size:14px;
    }
    .btn-ghost{
      background:transparent;border:1px solid rgba(15,23,42,0.06);color:#07142a;
    }
    .btn-primary{
      background:linear-gradient(90deg,var(--accent),#c71b1b); color:#fff;
      box-shadow: 0 8px 20px rgba(185,28,28,0.12);
    }
    .btn-logout{
      background:#fff;border:1px solid rgba(15,23,42,0.06);color:var(--muted);
    }
    
    /* Transfer specific styles */
    .btn-transfer-new { 
        background: linear-gradient(90deg, #10b981, #059669); 
        color: #fff; 
        box-shadow: 0 8px 20px rgba(16, 185, 129, 0.2); 
    }
    .transfer-btn{ 
        background: linear-gradient(90deg, #10b981, #059669); 
        color: #fff; 
    }
    .patient-entry { 
        display: grid;
        grid-template-columns: 1fr 80px 30px; 
        gap: 8px;
        align-items: flex-end;
        margin-top: 10px;
    }
    .patient-entry .remove-btn {
        background: var(--danger);
        color: white;
        padding: 8px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        line-height: 1;
        height: 38px;
    }
    
    /* Removed old list styles for transfers */

    .today{
      display:flex;gap:12px;align-items:flex-start;margin-bottom:18px;
    }
    .today .today-card{
      flex:1;
      background:linear-gradient(180deg, rgba(0,120,212,0.06), rgba(255,255,255,0.6));
      padding:14px;border-radius:12px;border:1px solid rgba(7,89,133,0.06);
      min-height:64px;
    }
    .today .today-card h3{margin:0;font-size:13px;color:var(--accent-2)}
    .today ul{margin:8px 0 0 16px;color:var(--muted);padding:0}

    /* CARD-BASED LAYOUT FOR APPOINTMENTS (replacing table) */
    .table-wrap{
      border-radius:var(--radius);
      overflow:visible;
      border:none;
      background:none;
      padding: 0;
    }
    .appointments-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
      gap: 16px;
      margin-top: 16px;
    }
    .appointment-card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 18px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(15,23,42,0.04);
      transition: all 0.3s ease;
    }
    .appointment-card:hover {
        box-shadow: 0 10px 30px rgba(18,38,63,0.1);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(15,23,42,0.05);
      padding-bottom: 8px;
      margin-bottom: 8px;
    }
    .card-name {
      font-size: 18px;
      font-weight: 700;
      color: var(--accent);
      margin: 0;
      line-height: 1;
    }
    .card-room {
      background: rgba(0,120,212,0.1);
      color: var(--accent-2);
      font-weight: 600;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 13px;
    }
    .card-detail {
      display: flex;
      gap: 8px;
      font-size: 14px;
      margin-bottom: 6px;
    }
    .card-label {
      font-weight: 600;
      color: var(--muted);
      min-width: 70px; /* Aligns labels nicely */
    }
    .card-actions {
      display: flex;
      gap: 8px;
      margin-top: 16px;
      justify-content: flex-end;
    }
    
    .edit { background:linear-gradient(90deg,#06b6d4,#0ea5e9); color:#fff }
    .del { background:linear-gradient(90deg,#f97316,#ef4444); color:#fff }

    /* TRANSFER CARDS (Sidebar) */
    .transfer-cards-container {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    .transfer-card {
        padding: 10px;
        border-radius: 8px;
        background: rgba(16, 185, 129, 0.08); /* light green background */
        border-left: 4px solid var(--success);
        font-size: 13px;
    }
    .transfer-card .bewohner-info {
        font-weight: 700;
        color: #07142a;
        margin-bottom: 2px;
    }
    .transfer-card .datetime-info {
        color: var(--muted);
    }


    /* Removed all table-specific CSS: table, thead, tbody, td, th */


    /* right column */
    .side{
      width:320px;flex:0 0 320px;position:sticky;top:28px;
      display:flex;flex-direction:column;gap:var(--gap);
    }
    .card{
      background:var(--card);border-radius:12px;padding:14px;box-shadow:var(--shadow);
      border:1px solid rgba(15,23,42,0.04)
    }
    .card h4{margin:0 0 8px 0;font-size:15px}
    .stat{display:flex;align-items:center;gap:12px}
    .stat .num{font-weight:700;font-size:20px;color:#07142a}
    .small{font-size:13px;color:var(--muted)}

    /* Card for Current Date and Time */
    .card .stat.datetime{
        flex-direction:column; 
        align-items:flex-start; 
        gap:4px;
    }
    .card .stat.datetime .num {
        font-size: 18px; 
    }

    footer.copy{font-size:13px;color:var(--muted);text-align:center;padding:12px 0}

    /* modal beautiful */
    .modal{
      display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
      background:linear-gradient(180deg,#fff,#fafbff);padding:0;border-radius:14px;z-index:1200;width:520px;
      box-shadow: 0 30px 80px rgba(6,12,34,0.22);
    }
    .modal .head{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;padding:14px;border-radius:12px 12px 0 0;display:flex;justify-content:space-between;align-items:center}
    .modal .body{padding:16px}
    .modal label{display:block;margin-top:8px;font-size:13px;color:var(--muted)}
    .modal input, .modal textarea{width:100%;padding:10px;margin-top:6px;border-radius:10px;border:1px solid rgba(15,23,42,0.06);font-size:14px}
    .modal .foot{padding:12px;text-align:right;border-top:1px solid rgba(15,23,42,0.03)}
    .modal button{padding:10px 14px;border-radius:10px;border:0;font-weight:700;cursor:pointer}

    /* login panel - UPDATED for full screen white background */
    #loginScreen{
      width:100%;
      height:100vh;
      position:fixed;
      top:0;
      left:0;
      z-index:1300;
      /* Style the inner content for centering */
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      background: #ffffff; /* Explicitly white background */
    }
    
    /* Inner content card within the full screen */
    #loginCard {
        width:420px;
        border-radius:16px;
        padding:20px;
        background:var(--card);
        box-shadow:var(--shadow);
        border:1px solid rgba(15,23,42,0.04);
    }

    #loginScreen h2{margin:0 0 8px 0}
    #loginScreen label{display:block;margin-top:10px;color:var(--muted)}
    #loginScreen input{width:100%;padding:10px;margin-top:6px;border-radius:10px;border:1px solid rgba(15,23,42,0.06)}

    .centered{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;padding:10px}

    /* responsive adjustments */
    @media (max-width:1024px){
      .wrap{flex-direction:column;padding:18px}
      .side{width:100%;flex:0 0 auto;position:static}
      .panel{order:0}
      .appointments-grid {
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      }
    }

    @media (max-width:560px){
      body{padding:0} /* Removed body padding to allow full screen login */
      .panel{padding:14px;border-radius:10px}
      header.app-header{gap:10px}
      .logo{width:52px;height:52px;font-size:16px}
      .side{display:none}
      /* Card-based layout is responsive by default, but we should simplify the login card */
      #loginCard{width:100%;border-radius:0;box-shadow:none;border:none;padding:20px} 
    }

    /* focus */
    input:focus, button:focus{outline:3px solid rgba(2,6,23,0.06);outline-offset:2px}
  </style>
</head>
<body>
  
  <div id="loginScreen">
    <div id="loginCard">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
        <div style="width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800">DRK</div>
        <div>
            <h2 style="margin:0">Login erforderlich</h2>
            <div class="small muted">Bitte mit Ihrem 4-stelligen PIN anmelden</div>
        </div>
        </div>

        <label for="pin">PIN eingeben</label>
        <input id="pin" type="password" inputmode="numeric" pattern="\d{4}" maxlength="4" required>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
        <div class="small muted"></div>
        <div style="display:flex;gap:8px">
            <button class="btn btn-primary" id="loginBtn">Einloggen</button>
        </div>
        </div>

        <div id="loginError" class="small" style="color:var(--danger);margin-top:10px;min-height:18px"></div>
    </div>
  </div>

  <div class="wrap" role="main" style="display:none;" id="mainAppWrap"> 
    <div class="panel" id="appArea" aria-hidden="true">
      <header class="app-header">
        <div class="logo">DRK</div>
        <div class="title">
          <h1>DRK Terminverwaltung</h1>
          <p>Übersicht, Verwaltung und sichere Anzeige Ihrer Termine</p>
        </div>
      </header>

      <div class="controls">
        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn btn-primary" onclick="openModal()">➕ Neuer Termin</button>
          <button class="btn btn-transfer-new" onclick="openNewTransferModal()">➕ Neuer Transfer</button> 
        </div>
        <div style="margin-left:auto;display:flex;gap:8px">
          <button class="btn btn-ghost" onclick="exportJSON()">🔽 Export</button>
          <button class="btn btn-logout" onclick="logout()">Abmelden</button>
        </div>
      </div>

      <div class="today">
        <div class="today-card">
          <h3>Heute</h3>
          <ul id="todayAppointments" class="muted"></ul>
        </div>
        <div class="today-card">
          <h3>Schnellinfo</h3>
          <div class="small muted" id="quickInfo">Keine Termine</div>
        </div>
      </div>

      <div class="table-wrap" role="region" aria-label="Termin-Karten">
        <div class="appointments-grid" id="appointmentList">
          </div>
      </div>
      <div style="height:12px"></div>
      <footer class="copy small muted">entwickelt von Aymen Bakkour</footer>
    </div>

    <aside class="side" aria-hidden="true">
      <div class="card">
        <h4>Statistiken</h4>
        <div class="stat" style="justify-content:space-between">
          <div><div class="num" id="statTotal">0</div><div class="small muted">Gesamt</div></div>
          <div><div class="num" id="statToday">0</div><div class="small muted">Heute</div></div>
        </div>
      </div>
      
      <div class="card">
        <h4>Aktuelles Datum & Uhrzeit</h4>
        <div class="stat datetime">
          <div class="num" id="currentDate">Datum wird geladen...</div>
          <div class="small muted" id="currentTime">Uhrzeit wird geladen...</div>
        </div>
      </div>
      
      <div class="card">
          <h4>Letzte Transfers</h4>
          <div id="latestTransfers">
              <div id="transferList" class="transfer-cards-container">
                  <div class="small muted" style="padding: 10px 0;">Keine Transfers gespeichert.</div>
              </div>
          </div>
      </div>


      <div class="card centered" aria-hidden="false">
        <div style="font-size:36px;font-weight:800;color:var(--accent)">❤️</div>
        <div class="small muted">Eine freundliche, übersichtliche Oberfläche für Ihre Terminverwaltung.</div>
      </div>
    </aside>
  </div>

  <div class="modal" id="appointmentModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="head">
      <div id="modalTitle">Neuer Termin</div>
      <button onclick="closeModal()" aria-label="Schließen" style="background:transparent;color:#fff;border:0;font-weight:800;font-size:18px;cursor:pointer">✕</button>
    </div>
    <div class="body">
      <form id="appointmentForm">
        <input type="hidden" id="editIndex">
        <label for="firstName">Vorname</label>
        <input id="firstName" type="text" required autocomplete="given-name">

        <label for="lastName">Nachname</label>
        <input id="lastName" type="text" required autocomplete="family-name">

        <label for="room">Zimmernummer</label>
        <input id="room" type="text" required>

        <label for="address">Adresse</label>
        <input id="address" type="text" required autocomplete="street-address">

        <label for="date">Datum</label>
        <input id="date" type="date" required>

        <label for="time">Uhrzeit</label>
        <input id="time" type="time" required>

        <div class="foot">
          <button type="button" onclick="closeModal()" class="btn btn-ghost">Abbrechen</button>
          <button type="submit" class="btn btn-primary">Speichern</button>
        </div>
      </form>
    </div>
  </div>
  
  <div class="modal" id="transferModal" role="dialog" aria-modal="true" aria-labelledby="transferModalTitle">
    <div class="head">
      <div id="transferModalTitle">Bewohnertransfer (Aus Termin)</div> 
      <button onclick="closeTransferModal()" aria-label="Schließen" style="background:transparent;color:#fff;border:0;font-weight:800;font-size:18px;cursor:pointer">✕</button>
    </div>
    <div class="body">
      <form id="transferForm">
        <input type="hidden" id="transferIndex">
        
        <label>Übertragener Bewohner</label>
        <div class="patient-entry">
            <input type="text" id="transferName" placeholder="Name" readonly>
            <input type="text" id="transferRoom" placeholder="Zimmer" readonly>
            <button type="button" style="visibility:hidden" disabled class="remove-btn">✕</button>
        </div>
        <label for="transferDate">Datum</label>
        <input id="transferDate" type="date" readonly>

        <label for="transferTime">Uhrzeit</label>
        <input id="transferTime" type="time" readonly>

        <label for="transferNotes">Bemerkungen/Notizen</label>
        <textarea id="transferNotes" style="min-height:100px;resize:vertical;" placeholder="Geben Sie hier zusätzliche Bemerkungen zum Transfer ein."></textarea>
        
        <div class="foot">
          <button type="button" onclick="closeTransferModal()" class="btn btn-ghost">Abbrechen</button>
          <button type="submit" class="btn btn-primary transfer-btn">Transfer speichern</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal" id="newTransferModal" role="dialog" aria-modal="true" aria-labelledby="newTransferModalTitle">
    <div class="head">
      <div id="newTransferModalTitle">Neuer Bewohnertransfer eintragen</div> 
      <button onclick="closeNewTransferModal()" aria-label="Schließen" style="background:transparent;color:#fff;border:0;font-weight:800;font-size:18px;cursor:pointer">✕</button>
    </div>
    <div class="body">
      <form id="newTransferForm">

        <label>Datum und Uhrzeit</label>
        <div style="display:flex; gap:10px;">
            <input id="newTransferDate" type="date" required style="flex:1">
            <input id="newTransferTime" type="time" required style="flex:1">
        </div>

        <label style="margin-top:16px;">Bewohner (Name und Zimmernummer)</label>
        <div id="newBewohnerListContainer">
            </div>

        <button type="button" class="btn btn-ghost" onclick="addBewohnerField('newBewohnerListContainer')">
            ➕ Bewohner hinzufügen
        </button>

        <label for="newTransferNotes">Bemerkungen/Notizen</label>
        <textarea id="newTransferNotes" style="min-height:100px;resize:vertical;" placeholder="Geben Sie hier zusätzliche Bemerkungen zum Transfer ein."></textarea>
        
        <div class="foot">
          <button type="button" onclick="closeNewTransferModal()" class="btn btn-ghost">Abbrechen</button>
          <button type="submit" class="btn btn-primary transfer-btn">Transfer speichern</button>
        </div>
      </form>
    </div>
  </div>
  <script>
    // Credentials (keine Anzeige im UI)
    const VALID_PIN = '9001'; 

    // DOM
    const loginScreen = document.getElementById('loginScreen');
    const loginBtn = document.getElementById('loginBtn');
    const loginError = document.getElementById('loginError');
    const appArea = document.getElementById('appArea');
    const mainAppWrap = document.getElementById('mainAppWrap'); // Reference to the main app container
    const appointmentList = document.getElementById('appointmentList'); // Now the grid container
    const todayAppointments = document.getElementById('todayAppointments');
    const statTotal = document.getElementById('statTotal');
    const statToday = document.getElementById('statToday');
    const quickInfo = document.getElementById('quickInfo');
    const modal = document.getElementById('appointmentModal');
    const form = document.getElementById('appointmentForm');
    const transferModal = document.getElementById('transferModal');
    const transferForm = document.getElementById('transferForm');
    const newTransferModal = document.getElementById('newTransferModal');
    const newTransferForm = document.getElementById('newTransferForm');
    const transferList = document.getElementById('transferList'); // Now the transfer card container
    const newBewohnerListContainer = document.getElementById('newBewohnerListContainer'); 
    const currentDateElement = document.getElementById('currentDate');
    const currentTimeElement = document.getElementById('currentTime');
    const pinInput = document.getElementById('pin'); 


    let appointments = [];
    let transfers = []; 

    function escapeHtml(s){ if (s===undefined||s===null) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }
    function todayISO(){ return new Date().toISOString().split('T')[0]; }
    
    // --- Login Flow ---
    loginBtn.addEventListener('click', checkLogin);
    if (pinInput) { pinInput.addEventListener('keydown', e => { if (e.key==='Enter') checkLogin() }); } 

    function checkLogin(){
      const pin = document.getElementById('pin').value.trim();
      if (pin === VALID_PIN){
        loginError.textContent = '';
        openApp();
      } else {
        loginError.textContent = 'Falscher PIN.'; 
      }
    }

    function openApp(){
      loginScreen.style.display = 'none';
      mainAppWrap.style.display = 'flex'; // Show the main app content
      appArea.setAttribute('aria-hidden','false');
      loadAppointments();
      loadTransfers(); 
      renderAppointments();
      renderTransfers();
      updateDateTime();
      setInterval(updateDateTime, 1000);
    }

    function logout(){
      appArea.setAttribute('aria-hidden','true');
      mainAppWrap.style.display = 'none'; // Hide the main app content
      loginScreen.style.display = 'flex'; // Show the login screen
      const pinInput = document.getElementById('pin');
      if (pinInput) pinInput.value = ''; 
      loginError.textContent = '';
      if (pinInput) pinInput.focus();
    }

    // --- Storage ---
    function loadAppointments(){
      const raw = localStorage.getItem('appointments') || '[]';
      try { appointments = JSON.parse(raw) } catch { appointments = [] }
    }
    function saveAppointments(){ localStorage.setItem('appointments', JSON.stringify(appointments)) }

    function loadTransfers(){
      const raw = localStorage.getItem('transfers') || '[]';
      try { transfers = JSON.parse(raw) } catch { transfers = [] }
    }
    function saveTransfers(){ localStorage.setItem('transfers', JSON.stringify(transfers)) }


    // --- Rendering Appointments as Cards ---
    function renderAppointments(){
        const today = todayISO();
        const todayCount = appointments.filter(a => a.date === today).length;
        
        // Clear containers
        appointmentList.innerHTML = ''; // This is the appointments-grid
        todayAppointments.innerHTML = ''; 

        appointments.forEach((a, i) => {
            // --- 1. Create Appointment Card (main list) ---
            const card = document.createElement('div');
            card.className = 'appointment-card';
            // Add a highlight class for today's appointments
            if (a.date === today) {
                card.style.border = '1px solid var(--accent-2)';
                card.style.boxShadow = '0 6px 16px rgba(0,120,212,0.1)';
            }

            card.innerHTML = `
                <div class="card-header">
                    <h4 class="card-name">${escapeHtml(a.firstName)} ${escapeHtml(a.lastName)}</h4>
                    <span class="card-room">${escapeHtml(a.room)}</span>
                </div>
                <div class="card-detail">
                    <span class="card-label">Datum:</span>
                    <span>${escapeHtml(a.date)}</span>
                </div>
                <div class="card-detail">
                    <span class="card-label">Uhrzeit:</span>
                    <span>${escapeHtml(a.time)}</span>
                </div>
                <div class="card-detail">
                    <span class="card-label">Adresse:</span>
                    <span class="muted" style="text-overflow: ellipsis; overflow: hidden; white-space: nowrap;">${escapeHtml(a.address)}</span>
                </div>
                <div class="card-actions">
                    <button class="edit btn" onclick="openModal(${i})">Bearbeiten</button>
                    <button class="del btn" onclick="deleteAppointment(${i})">Löschen</button>
                    <button class="btn transfer-btn" onclick="openTransferModal(${i})">Transfer</button>
                </div>
            `;
            appointmentList.appendChild(card);

            // --- 2. Create Today's List Item ---
            if (a.date === today){
              const li = document.createElement('li');
              li.textContent = `${a.firstName} ${a.lastName} (${a.room}) um ${a.time}`;
              todayAppointments.appendChild(li);
            }
        });

        // Update stats and quick info
        statTotal.textContent = appointments.length;
        statToday.textContent = todayCount;
        quickInfo.textContent = appointments.length ? `${appointments.length} Termine insgesamt` : 'Keine Termine vorhanden';
        
        // Handle empty list case (Updated for card layout)
        if (!appointments.length) {
            const emptyMessage = document.createElement('div');
            emptyMessage.style.textAlign = 'center';
            emptyMessage.style.padding = '18px';
            emptyMessage.style.color = 'var(--muted)';
            emptyMessage.textContent = 'Keine Termine vorhanden';
            appointmentList.appendChild(emptyMessage);
        }
    }
    
    // --- Rendering Transfers as Cards ---
    function renderTransfers(){
        transferList.innerHTML = ''; // This is the transfer-cards-container
        if (transfers.length === 0) {
            transferList.innerHTML = `<div class="small muted" style="padding: 10px 0;">Keine Transfers gespeichert.</div>`;
            return;
        }

        // Display up to 5 latest transfers
        transfers.slice(-5).reverse().forEach(t => {
            const card = document.createElement('div');
            card.className = 'transfer-card';
            const bewohnerCount = t.bewohner ? t.bewohner.length : 0; 
            const dateStr = t.date === todayISO() ? 'Heute' : t.date;
            
            const bewohnerInfo = bewohnerCount > 1 
                ? `${bewohnerCount} Bewohner` 
                : (bewohnerCount === 1 ? `${t.bewohner[0].name} (${t.bewohner[0].room})` : 'Unbekannter Bewohner');
            
            card.innerHTML = `
                <div class="bewohner-info">${bewohnerInfo}</div>
                <div class="datetime-info">${dateStr}, ${escapeHtml(t.time)}</div>
                <div class="small muted" style="margin-top: 4px; border-top: 1px dashed rgba(15,23,42,0.05); padding-top: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${t.notes.substring(0, 50)}</div>
            `;
            transferList.appendChild(card);
        });
    }

    // Function to update the date and time display
    function updateDateTime() {
      const now = new Date();
      const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      const dateStr = now.toLocaleDateString('de-DE', dateOptions);

      const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit' };
      const timeStr = now.toLocaleTimeString('de-DE', timeOptions);

      if (currentDateElement) currentDateElement.textContent = dateStr;
      if (currentTimeElement) currentTimeElement.textContent = timeStr;
    }


    // --- Appointment Modal ---
    function openModal(index=null){
      document.getElementById('editIndex').value = index !== null ? index : '';
      document.getElementById('modalTitle').textContent = index !== null ? 'Termin bearbeiten' : 'Neuer Termin';
      if (index !== null){
        const a = appointments[index];
        document.getElementById('firstName').value = a.firstName || '';
        document.getElementById('lastName').value = a.lastName || '';
        document.getElementById('room').value = a.room || '';
        document.getElementById('address').value = a.address || '';
        document.getElementById('date').value = a.date || '';
        document.getElementById('time').value = a.time || '';
      } else {
        form.reset();
        document.getElementById('date').value = todayISO();
      }
      modal.style.display = 'block';
      document.getElementById('firstName').focus();
    }
    function closeModal(){ modal.style.display = 'none' }

    form.addEventListener('submit', e => {
      e.preventDefault();
      const a = {
        firstName: document.getElementById('firstName').value.trim(),
        lastName: document.getElementById('lastName').value.trim(),
        room: document.getElementById('room').value.trim(),
        address: document.getElementById('address').value.trim(),
        date: document.getElementById('date').value,
        time: document.getElementById('time').value
      };
      const idx = document.getElementById('editIndex').value;
      if (idx === '') appointments.push(a); else appointments[idx] = a;
      saveAppointments();
      renderAppointments();
      closeModal();
    });
    
    // --- Dynamic Bewohner Fields (Helper) ---
    function addBewohnerField(containerId, name = '', room = '', isReadOnly = false) { 
        const container = document.getElementById(containerId);
        const div = document.createElement('div');
        div.className = 'patient-entry';
        
        const nameInput = document.createElement('input');
        nameInput.type = 'text';
        nameInput.placeholder = 'Bewohner Name'; 
        nameInput.required = !isReadOnly;
        nameInput.value = name;
        nameInput.readOnly = isReadOnly;
        nameInput.name = 'bewohnerName'; 
        
        const roomInput = document.createElement('input');
        roomInput.type = 'text';
        roomInput.placeholder = 'Zimmer Nr.';
        roomInput.required = !isReadOnly;
        roomInput.value = room;
        roomInput.readOnly = isReadOnly;
        roomInput.name = 'bewohnerRoom'; 
        roomInput.style.width = '80px';

        const removeButton = document.createElement('button');
        removeButton.type = 'button';
        removeButton.className = 'remove-btn';
        removeButton.textContent = '✕';
        removeButton.onclick = () => div.remove();
        
        if (isReadOnly) {
            removeButton.style.visibility = 'hidden';
            removeButton.disabled = true;
            div.appendChild(nameInput);
            div.appendChild(roomInput);
            div.appendChild(removeButton);
        } else {
            div.appendChild(nameInput);
            div.appendChild(roomInput);
            div.appendChild(removeButton);
        }

        container.appendChild(div);
        return { nameInput, roomInput };
    }

    function collectBewohnerData(containerId) { 
        const container = document.getElementById(containerId);
        const entries = container.querySelectorAll('.patient-entry');
        const bewohner = []; 

        entries.forEach(entry => {
            const nameInput = entry.querySelector('input[name="bewohnerName"]'); 
            const roomInput = entry.querySelector('input[name="bewohnerRoom"]');
            
            if (nameInput.value.trim() && roomInput.value.trim()) {
                bewohner.push({ 
                    name: nameInput.value.trim(),
                    room: roomInput.value.trim()
                });
            }
        });
        return bewohner; 
    }

    // --- Contextual Transfer Modal (from Appointment) ---
    function openTransferModal(index){
        const a = appointments[index];
        document.getElementById('transferIndex').value = index;
        
        const nameInput = document.getElementById('transferName');
        const roomInput = document.getElementById('transferRoom');
        nameInput.value = `${a.firstName || ''} ${a.lastName || ''}`;
        roomInput.value = a.room || '';

        document.getElementById('transferDate').value = a.date || '';
        document.getElementById('transferTime').value = a.time || '';
        document.getElementById('transferNotes').value = ''; 
        
        transferModal.style.display = 'block';
        document.getElementById('transferNotes').focus();
    }

    function closeTransferModal(){ transferModal.style.display = 'none' }

    transferForm.addEventListener('submit', e => {
        e.preventDefault();
        
        const t = {
            timestamp: new Date().toISOString(),
            date: document.getElementById('transferDate').value,
            time: document.getElementById('transferTime').value,
            notes: document.getElementById('transferNotes').value.trim() || 'Keine Notizen',
            bewohner: [{ 
                name: document.getElementById('transferName').value,
                room: document.getElementById('transferRoom').value
            }]
        };
        
        transfers.push(t); 
        saveTransfers();
        renderTransfers();

        alert(`Transfer für ${t.bewohner[0].name} (Aus Termin) erfolgreich gespeichert!`); 
        closeTransferModal();
    });

    // --- New Transfer Modal (Multiple Residents) ---
    function openNewTransferModal(){
        newTransferForm.reset();
        document.getElementById('newTransferDate').value = todayISO();
        newBewohnerListContainer.innerHTML = ''; 
        addBewohnerField('newBewohnerListContainer'); 
        newTransferModal.style.display = 'block';
        document.getElementById('newTransferDate').focus();
    }

    function closeNewTransferModal(){ newTransferModal.style.display = 'none' }

    newTransferForm.addEventListener('submit', e => {
        e.preventDefault();
        
        const bewohner = collectBewohnerData('newBewohnerListContainer'); 

        if (bewohner.length === 0) {
            alert('Bitte mindestens einen Bewohner hinzufügen.');
            return;
        }

        const t = {
            timestamp: new Date().toISOString(),
            date: document.getElementById('newTransferDate').value,
            time: document.getElementById('newTransferTime').value,
            notes: document.getElementById('newTransferNotes').value.trim() || 'Keine Notizen',
            bewohner: bewohner 
        };
        
        transfers.push(t); 
        saveTransfers();
        renderTransfers();

        alert(`Neuer Transfer für ${bewohner.length} Bewohner erfolgreich gespeichert!`); 
        closeNewTransferModal();
    });


    // --- Delete and Utilities ---
    function deleteAppointment(i){
      if (!confirm('Diesen Termin wirklich löschen?')) return;
      appointments.splice(i,1);
      saveAppointments();
      renderAppointments();
    }

    function exportJSON(){
      const dataStr = JSON.stringify({ appointments, transfers },null,2);
      const blob = new Blob([dataStr],{type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'drk_data.json'; document.body.appendChild(a); a.click();
      a.remove(); URL.revokeObjectURL(url);
    }

    window.addEventListener('load', () => {
      // Initialize on load, but keep main app hidden
      loadAppointments();
      loadTransfers(); 
      // Ensure the login screen is visible and main app is hidden initially
      loginScreen.style.display = 'flex';
      mainAppWrap.style.display = 'none';
      if (pinInput) pinInput.focus();
    });

    // close modal by clicking outside
    window.addEventListener('click', e => {
      if (e.target === modal) closeModal();
      if (e.target === transferModal) closeTransferModal();
      if (e.target === newTransferModal) closeNewTransferModal();
    });
  </script>
</body>
</html>
