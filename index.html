<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>DRK Terminverwaltung — Modern</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f3f6f9;
      --card:#ffffff;
      --muted:#6b7280;
      --accent:#b91c1c;
      --accent-2:#0078D4;
      --glass: rgba(255,255,255,0.6);
      --shadow: 0 6px 20px rgba(18,38,63,0.08);
      --radius:12px;
      --glass-border: rgba(255,255,255,0.6);
      --success:#10b981;
      --danger:#ef4444;
      --max-width:1100px;
      --gap:16px;
      --transition:200ms cubic-bezier(.2,.9,.3,1);
      --mono: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family:var(--mono);
      margin:0;
      background:
        radial-gradient(1000px 600px at 10% 10%, rgba(0,120,212,0.06), transparent 12%),
        radial-gradient(800px 500px at 90% 90%, rgba(185,28,28,0.04), transparent 12%),
        var(--bg);
      color:#0f172a;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding:28px;
      display:flex;
      justify-content:center;
    }

    .wrap{
      width:100%;
      max-width:var(--max-width);
      display:flex;
      gap:var(--gap);
      align-items:flex-start;
    }

    /* left column */
    .panel{
      flex:1 1 680px;
      background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(250,250,250,0.9));
      border-radius:var(--radius);
      padding:20px;
      box-shadow:var(--shadow);
      border:1px solid rgba(15,23,42,0.04);
      backdrop-filter: blur(6px) saturate(120%);
    }

    header.app-header{
      display:flex;
      gap:12px;
      align-items:center;
      margin-bottom:18px;
    }
    .logo{
      width:64px;height:64px;border-radius:12px;
      background: linear-gradient(135deg,var(--accent),var(--accent-2));
      display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:20px;
      box-shadow: 0 8px 24px rgba(7,89,133,0.12), inset 0 -6px 18px rgba(255,255,255,0.06);
    }
    .title{
      display:flex;flex-direction:column;
    }
    .title h1{font-size:20px;margin:0;color:#07142a}
    .title p{margin:2px 0 0 0;color:var(--muted);font-size:13px}

    .controls{
      display:flex;
      gap:10px;
      margin:12px 0 18px 0;
      flex-wrap:wrap;
    }
    .btn{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 14px;border-radius:10px;border:0;cursor:pointer;
      transition:all var(--transition);
      font-weight:600;font-size:14px;
    }
    .btn-ghost{
      background:transparent;border:1px solid rgba(15,23,42,0.06);color:#07142a;
    }
    .btn-primary{
      background:linear-gradient(90deg,var(--accent),#c71b1b); color:#fff;
      box-shadow: 0 8px 20px rgba(185,28,28,0.12);
    }
    .btn-logout{
      background:#fff;border:1px solid rgba(15,23,42,0.06);color:var(--muted);
    }
    /* تنسيق زر Transfer الجديد في الكنترول */
    .btn-transfer-new { 
        background: linear-gradient(90deg, #10b981, #059669); 
        color: #fff; 
        box-shadow: 0 8px 20px rgba(16, 185, 129, 0.2); 
    }

    .today{
      display:flex;gap:12px;align-items:flex-start;margin-bottom:18px;
    }
    .today .today-card{
      flex:1;
      background:linear-gradient(180deg, rgba(0,120,212,0.06), rgba(255,255,255,0.6));
      padding:14px;border-radius:12px;border:1px solid rgba(7,89,133,0.06);
      min-height:64px;
    }
    .today .today-card h3{margin:0;font-size:13px;color:var(--accent-2)}
    .today ul{margin:8px 0 0 16px;color:var(--muted);padding:0}

    /* table card */
    .table-wrap{
      border-radius:12px;overflow:hidden;border:1px solid rgba(15,23,42,0.04);
      background:linear-gradient(180deg,#fff,#fbfbfd);
    }
    table{
      width:100%;border-collapse:collapse;font-size:14px;
    }
    thead th{
      text-align:left;padding:12px 16px;background:transparent;color:var(--muted);
      font-weight:600;font-size:12px;border-bottom:1px solid rgba(15,23,42,0.04);
    }
    /* إخفاء رأس عمود Aktionen */
    thead th:last-child {
        display: none;
    }
    
    tbody tr{
      transition:background var(--transition);border-bottom:1px solid rgba(15,23,42,0.03);
    }
    tbody tr:hover{background:linear-gradient(90deg, rgba(7,89,133,0.02), rgba(185,28,28,0.01))}
    td{padding:14px 16px;vertical-align:middle}
    .muted{color:var(--muted);font-size:13px}
    .chip{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(15,23,42,0.04);font-size:13px}

    td.actions{display:flex;gap:8px}
    td.actions button{padding:8px 10px;border-radius:8px;font-weight:600;border:0;cursor:pointer}
    .edit{background:linear-gradient(90deg,#06b6d4,#0ea5e9);color:#fff}
    .del{background:linear-gradient(90deg,#f97316,#ef4444);color:#fff}
    /* تنسيق زر Transfer الجديد */
    .transfer-btn{ background: linear-gradient(90deg, #10b981, #059669); color: #fff; }


    /* right column */
    .side{
      width:320px;flex:0 0 320px;position:sticky;top:28px;
      display:flex;flex-direction:column;gap:var(--gap);
    }
    .card{
      background:var(--card);border-radius:12px;padding:14px;box-shadow:var(--shadow);
      border:1px solid rgba(15,23,42,0.04)
    }
    .card h4{margin:0 0 8px 0;font-size:15px}
    .stat{display:flex;align-items:center;gap:12px}
    .stat .num{font-weight:700;font-size:20px;color:#07142a}
    .small{font-size:13px;color:var(--muted)}
    
    /* قائمة التحويلات الأخيرة */
    #latestTransfers ul { list-style: none; margin: 0; padding: 0; }
    #latestTransfers li { 
        padding: 8px 0; 
        border-bottom: 1px dashed rgba(15,23,42,0.05); 
        font-size: 13px; 
    }
    #latestTransfers li:last-child { border-bottom: none; }
    #latestTransfers .name { font-weight: 600; color: #07142a; }
    #latestTransfers .details { color: var(--muted); display: block; margin-top: 2px; }

    footer.copy{font-size:13px;color:var(--muted);text-align:center;padding:12px 0}

    /* modal beautiful */
    .modal{
      display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
      background:linear-gradient(180deg,#fff,#fafbff);padding:0;border-radius:14px;z-index:1200;width:520px;
      box-shadow: 0 30px 80px rgba(6,12,34,0.22);
    }
    .modal .head{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;padding:14px;border-radius:12px 12px 0 0;display:flex;justify-content:space-between;align-items:center}
    .modal .body{padding:16px}
    .modal label{display:block;margin-top:8px;font-size:13px;color:var(--muted)}
    .modal input, .modal textarea{width:100%;padding:10px;margin-top:6px;border-radius:10px;border:1px solid rgba(15,23,42,0.06);font-size:14px}
    .modal .foot{padding:12px;text-align:right;border-top:1px solid rgba(15,23,42,0.03)}
    .modal button{padding:10px 14px;border-radius:10px;border:0;font-weight:700;cursor:pointer}

    /* login panel */
    #loginScreen{
      width:420px;border-radius:16px;padding:20px;background:linear-gradient(180deg,#fff,#fbfbff);box-shadow:var(--shadow);
      border:1px solid rgba(15,23,42,0.04);
    }
    #loginScreen h2{margin:0 0 8px 0}
    #loginScreen label{display:block;margin-top:10px;color:var(--muted)}
    #loginScreen input{width:100%;padding:10px;margin-top:6px;border-radius:10px;border:1px solid rgba(15,23,42,0.06)}

    .centered{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;padding:10px}

    /* responsive adjustments */
    @media (max-width:1024px){
      .wrap{flex-direction:column;padding:18px}
      .side{width:100%;flex:0 0 auto;position:static}
      .panel{order:0}
    }

    /* تعديلات الموبايل */
    @media (max-width:560px){
      body{padding:14px}
      .panel{padding:14px;border-radius:10px}
      header.app-header{gap:10px}
      .logo{width:52px;height:52px;font-size:16px}
      .side{display:none}
      
      /* إعداد عرض الجدول للموبايل */
      table, thead, tbody, th, td, tr{display:block}
      thead{display:none} /* إخفاء رأس الجدول بالكامل */
      
      tbody tr{
        margin-bottom:12px;border-radius:10px;padding:12px;border:1px solid rgba(15,23,42,0.04);background:#fff;
        display: grid; /* استخدام grid لترتيب العناصر بجمالية */
        grid-template-columns: 1fr 1fr; /* تقسيم العناصر إلى عمودين */
        grid-template-areas: 
          "name name" 
          "room address"
          "date time"
          "actions actions";
        gap: 10px; /* إضافة مسافة بين العناصر */
      }
      
      /* تخصيص موقع كل خلية في الـ grid */
      td[data-label="Vorname"] { 
          grid-area: name; 
          font-size: 16px; 
          font-weight: 700; 
          color: #07142a; 
          padding-bottom: 0; 
      }
      td[data-label="Zimmer"] { grid-area: room; }
      td[data-label="Adresse"] { grid-area: address; }
      td[data-label="Datum"] { grid-area: date; }
      td[data-label="Uhrzeit"] { grid-area: time; }
      td.actions { 
        grid-area: actions; 
        justify-content: flex-start; /* محاذاة الأزرار لليسار */
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px dashed rgba(15,23,42,0.05); /* خط فاصل للأزرار */
        display: flex; /* لضمان عرض الأزرار أفقياً */
        gap: 8px;
      }

      td{padding:6px 0}
      
      /* إخفاء تسمية Vorname (مطلوب) */
      td[data-label="Vorname"]:before { content: ""; display: none; }
      
      /* إخفاء تسمية Aktionen (مطلوب سابقاً) */
      td.actions:before { content: ""; display: none; } 
      
      /* إبقاء تسميات باقي الحقول */
      td:before{
        content:attr(data-label);display:block;font-weight:700;color:var(--muted);margin-bottom:6px
      }
      
      .chip { font-size: 14px; } /* تكبير خط الشريحة قليلاً */
      
      .modal{width:94%}
      #loginScreen{width:90%;border-radius:10px}
    }

    /* focus */
    input:focus, button:focus{outline:3px solid rgba(2,6,23,0.06);outline-offset:2px}
  </style>
</head>
<body>
  <div class="wrap" role="main">
    <div class="panel" id="appArea" aria-hidden="true">
      <header class="app-header">
        <div class="logo">DRK</div>
        <div class="title">
          <h1>DRK Terminverwaltung</h1>
          <p>Übersicht, Verwaltung und sichere Anzeige Ihrer Termine</p>
        </div>
      </header>

      <div class="controls">
        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn btn-primary" onclick="openModal()">➕ Neuer Termin</button>
          <button class="btn btn-transfer-new" onclick="openNewTransferModal()">➕ Neuer Transfer</button> 
        </div>
        <div style="margin-left:auto;display:flex;gap:8px">
          <button class="btn btn-ghost" onclick="exportJSON()">🔽 Export</button>
          <button class="btn btn-logout" onclick="logout()">Abmelden</button>
        </div>
      </div>

      <div class="today">
        <div class="today-card">
          <h3>Heute</h3>
          <ul id="todayAppointments" class="muted"></ul>
        </div>
        <div class="today-card">
          <h3>Schnellinfo</h3>
          <div class="small muted" id="quickInfo">Keine Termine</div>
        </div>
      </div>

      <div class="table-wrap" role="region" aria-label="Termintabelle">
        <table>
          <thead>
            <tr>
              <th>Vorname</th>
              <th>Nachname</th>
              <th>Zimmer</th>
              <th>Adresse</th>
              <th>Datum</th>
              <th>Uhrzeit</th>
              <th>Aktionen</th> </tr>
          </thead>
          <tbody id="appointmentList"></tbody>
        </table>
      </div>

      <div style="height:12px"></div>
      <footer class="copy small muted">entwickelt von Aymen Bakkour</footer>
    </div>

    <aside class="side" aria-hidden="true">
      <div class="card">
        <h4>Statistiken</h4>
        <div class="stat" style="justify-content:space-between">
          <div><div class="num" id="statTotal">0</div><div class="small muted">Gesamt</div></div>
          <div><div class="num" id="statToday">0</div><div class="small muted">Heute</div></div>
        </div>
      </div>
      
      <div class="card">
          <h4>Letzte Transfers</h4>
          <div id="latestTransfers">
              <ul id="transferList">
                  <li class="small muted">Keine Transfers gespeichert.</li>
              </ul>
          </div>
      </div>
      <div class="card">
        <h4>Schnelle Aktionen</h4>
        <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
          <button class="btn btn-ghost" onclick="clearAll()">Alle Termine löschen</button>
          <button class="btn btn-ghost" onclick="clearAllTransfers()">Alle Transfers löschen</button>
        </div>
      </div>

      <div class="card centered" aria-hidden="false">
        <div style="font-size:36px;font-weight:800;color:var(--accent)">❤️</div>
        <div class="small muted">Eine freundliche, übersichtliche Oberfläche für Ihre Terminverwaltung.</div>
      </div>
    </aside>
  </div>

  <div class="modal" id="appointmentModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="head">
      <div id="modalTitle">Neuer Termin</div>
      <button onclick="closeModal()" aria-label="Schließen" style="background:transparent;color:#fff;border:0;font-weight:800;font-size:18px;cursor:pointer">✕</button>
    </div>
    <div class="body">
      <form id="appointmentForm">
        <input type="hidden" id="editIndex">
        <label for="firstName">Vorname</label>
        <input id="firstName" type="text" required autocomplete="given-name">

        <label for="lastName">Nachname</label>
        <input id="lastName" type="text" required autocomplete="family-name">

        <label for="room">Zimmernummer</label>
        <input id="room" type="text" required>

        <label for="address">Adresse</label>
        <input id="address" type="text" required autocomplete="street-address">

        <label for="date">Datum</label>
        <input id="date" type="date" required>

        <label for="time">Uhrzeit</label>
        <input id="time" type="time" required>

        <div class="foot">
          <button type="button" onclick="closeModal()" class="btn btn-ghost">Abbrechen</button>
          <button type="submit" class="btn btn-primary">Speichern</button>
        </div>
      </form>
    </div>
  </div>
  
  <div class="modal" id="transferModal" role="dialog" aria-modal="true" aria-labelledby="transferModalTitle">
    <div class="head">
      <div id="transferModalTitle">Patiententransfer</div>
      <button onclick="closeTransferModal()" aria-label="Schließen" style="background:transparent;color:#fff;border:0;font-weight:800;font-size:18px;cursor:pointer">✕</button>
    </div>
    <div class="body">
      <form id="transferForm">
        <input type="hidden" id="transferIndex">
        <label for="transferFirstName">Vorname</label>
        <input id="transferFirstName" type="text" readonly>

        <label for="transferLastName">Nachname</label>
        <input id="transferLastName" type="text" readonly>

        <label for="transferRoom">Zimmernummer</label>
        <input id="transferRoom" type="text" readonly>

        <label for="transferDate">Datum</label>
        <input id="transferDate" type="date" readonly>

        <label for="transferTime">Uhrzeit</label>
        <input id="transferTime" type="time" readonly>

        <label for="transferNotes">Bemerkungen/Notizen</label>
        <textarea id="transferNotes" style="min-height:100px;resize:vertical;" placeholder="Geben Sie hier zusätzliche Bemerkungen zum Transfer ein."></textarea>
        
        <div class="foot">
          <button type="button" onclick="closeTransferModal()" class="btn btn-ghost">Abbrechen</button>
          <button type="submit" class="btn btn-primary transfer-btn">Transfer speichern</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal" id="newTransferModal" role="dialog" aria-modal="true" aria-labelledby="newTransferModalTitle">
    <div class="head">
      <div id="newTransferModalTitle">Neuer Patiententransfer eintragen</div>
      <button onclick="closeNewTransferModal()" aria-label="Schließen" style="background:transparent;color:#fff;border:0;font-weight:800;font-size:18px;cursor:pointer">✕</button>
    </div>
    <div class="body">
      <form id="newTransferForm">
        <label for="newTransferFirstName">Vorname</label>
        <input id="newTransferFirstName" type="text" required autocomplete="given-name">

        <label for="newTransferLastName">Nachname</label>
        <input id="newTransferLastName" type="text" required autocomplete="family-name">

        <label for="newTransferRoom">Zimmernummer</label>
        <input id="newTransferRoom" type="text" required>

        <label for="newTransferDate">Datum</label>
        <input id="newTransferDate" type="date" required>

        <label for="newTransferTime">Uhrzeit</label>
        <input id="newTransferTime" type="time" required>

        <label for="newTransferNotes">Bemerkungen/Notizen</label>
        <textarea id="newTransferNotes" style="min-height:100px;resize:vertical;" placeholder="Geben Sie hier zusätzliche Bemerkungen zum Transfer ein."></textarea>
        
        <div class="foot">
          <button type="button" onclick="closeNewTransferModal()" class="btn btn-ghost">Abbrechen</button>
          <button type="submit" class="btn btn-primary transfer-btn">Transfer speichern</button>
        </div>
      </form>
    </div>
  </div>
  <div id="loginScreen" class="card" style="position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:1300">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
      <div style="width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800">DRK</div>
      <div>
        <h2 style="margin:0">Login erforderlich</h2>
        <div class="small muted">Bitte mit Ihrem 4-stelligen PIN anmelden</div>
      </div>
    </div>

    <label for="pin">PIN eingeben</label>
    <input id="pin" type="password" inputmode="numeric" pattern="\d{4}" maxlength="4" required>

    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
      <div class="small muted"></div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-primary" id="loginBtn">Einloggen</button>
      </div>
    </div>

    <div id="loginError" class="small" style="color:var(--danger);margin-top:10px;min-height:18px"></div>
  </div>

  <script>
    // بيانات الاعتماد (PIN)
    const VALID_PIN = '9001';

    // DOM
    const loginScreen = document.getElementById('loginScreen');
    const loginBtn = document.getElementById('loginBtn');
    const loginError = document.getElementById('loginError');
    const appArea = document.getElementById('appArea');
    const appointmentList = document.getElementById('appointmentList');
    const todayAppointments = document.getElementById('todayAppointments');
    const statTotal = document.getElementById('statTotal');
    const statToday = document.getElementById('statToday');
    const quickInfo = document.getElementById('quickInfo');
    const modal = document.getElementById('appointmentModal');
    const form = document.getElementById('appointmentForm');
    const transferModal = document.getElementById('transferModal');
    const transferForm = document.getElementById('transferForm');
    const newTransferModal = document.getElementById('newTransferModal');
    const newTransferForm = document.getElementById('newTransferForm');
    const transferList = document.getElementById('transferList');
    const pinInput = document.getElementById('pin'); 

    let appointments = [];
    let transfers = []; // NEW: Array to store transfer data

    function escapeHtml(s){ if (s===undefined||s===null) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }
    function todayISO(){ return new Date().toISOString().split('T')[0]; }
    function formatTime(date) { return new Date(date).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }); }

    // login flow
    loginBtn.addEventListener('click', checkLogin);
    if (pinInput) { pinInput.addEventListener('keydown', e => { if (e.key==='Enter') checkLogin() }); }
    
    // منطق التحقق من PIN
    function checkLogin(){
      const pin = document.getElementById('pin').value.trim();
      if (pin !== VALID_PIN){
        loginError.textContent = 'Falscher PIN.';
        return;
      }
      
      loginError.textContent = '';
      openApp();
    }

    function openApp(){
      loginScreen.style.display = 'none';
      appArea.setAttribute('aria-hidden','false');
      loadAppointments();
      loadTransfers(); // NEW: Load transfers
      renderAppointments();
      renderTransfers(); // NEW: Render transfers
    }

    function logout(){
      appArea.setAttribute('aria-hidden','true');
      loginScreen.style.display = 'block';
      const pinInput = document.getElementById('pin');
      if (pinInput) pinInput.value = '';
      loginError.textContent = '';
    }

    // appointment storage
    function loadAppointments(){
      const raw = localStorage.getItem('appointments') || '[]';
      try { appointments = JSON.parse(raw) } catch { appointments = [] }
    }
    function saveAppointments(){ localStorage.setItem('appointments', JSON.stringify(appointments)) }

    // NEW: Transfer storage
    function loadTransfers(){
      const raw = localStorage.getItem('transfers') || '[]';
      try { transfers = JSON.parse(raw) } catch { transfers = [] }
    }
    function saveTransfers(){ localStorage.setItem('transfers', JSON.stringify(transfers)) }


    // render
    function renderAppointments(){
      appointmentList.innerHTML = '';
      todayAppointments.innerHTML = '';
      const today = todayISO();
      appointments.forEach((a,i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td data-label="Vorname">${escapeHtml(a.firstName)} ${escapeHtml(a.lastName)}</td>
          <td data-label="Nachname" style="display:none">${escapeHtml(a.lastName)}</td>
          <td data-label="Zimmer"><span class="chip">${escapeHtml(a.room)}</span></td>
          <td data-label="Adresse" class="muted">${escapeHtml(a.address)}</td>
          <td data-label="Datum">${escapeHtml(a.date)}</td>
          <td data-label="Uhrzeit">${escapeHtml(a.time)}</td>
          <td data-label="Aktionen" class="actions">
            <button class="edit" onclick="openModal(${i})">Bearbeiten</button>
            <button class="del" onclick="deleteAppointment(${i})">Löschen</button>
            <button class="btn transfer-btn" onclick="openTransferModal(${i})">Transfer</button>
          </td>
        `;
        appointmentList.appendChild(tr);
        if (a.date === today){
          const li = document.createElement('li');
          li.textContent = `${a.firstName} ${a.lastName} (${a.room}) um ${a.time} — ${a.address}`;
          todayAppointments.appendChild(li);
        }
      });
      statTotal.textContent = appointments.length;
      statToday.textContent = appointments.filter(a => a.date === todayISO()).length;
      quickInfo.textContent = appointments.length ? `${appointments.length} Termine insgesamt` : 'Keine Termine vorhanden';
      if (!appointments.length){
        const r = document.createElement('tr');
        r.innerHTML = `<td colspan="7" style="text-align:center;padding:18px;color:var(--muted)">Keine Termine</td>`;
        appointmentList.appendChild(r);
      }
    }
    
    // NEW: Render Transfers in Sidebar
    function renderTransfers(){
        transferList.innerHTML = '';
        if (transfers.length === 0) {
            transferList.innerHTML = `<li class="small muted">Keine Transfers gespeichert.</li>`;
            return;
        }

        // Display up to 5 latest transfers
        transfers.slice(-5).reverse().forEach(t => {
            const li = document.createElement('li');
            const dateStr = t.date === todayISO() ? 'Heute' : t.date;
            li.innerHTML = `
                <div class="name">${escapeHtml(t.firstName)} ${escapeHtml(t.lastName)} (${escapeHtml(t.room)})</div>
                <div class="details">${dateStr}, ${escapeHtml(t.time)} - ${t.notes.substring(0, 30)}...</div>
            `;
            transferList.appendChild(li);
        });
    }


    // Modal: Edit/New Appointment
    function openModal(index=null){
      document.getElementById('editIndex').value = index !== null ? index : '';
      document.getElementById('modalTitle').textContent = index !== null ? 'Termin bearbeiten' : 'Neuer Termin';
      if (index !== null){
        const a = appointments[index];
        document.getElementById('firstName').value = a.firstName || '';
        document.getElementById('lastName').value = a.lastName || '';
        document.getElementById('room').value = a.room || '';
        document.getElementById('address').value = a.address || '';
        document.getElementById('date').value = a.date || '';
        document.getElementById('time').value = a.time || '';
      } else {
        form.reset();
        document.getElementById('date').value = todayISO();
      }
      modal.style.display = 'block';
      document.getElementById('firstName').focus();
    }
    function closeModal(){ modal.style.display = 'none' }

    form.addEventListener('submit', e => {
      e.preventDefault();
      const a = {
        firstName: document.getElementById('firstName').value.trim(),
        lastName: document.getElementById('lastName').value.trim(),
        room: document.getElementById('room').value.trim(),
        address: document.getElementById('address').value.trim(),
        date: document.getElementById('date').value,
        time: document.getElementById('time').value
      };
      const idx = document.getElementById('editIndex').value;
      if (idx === '') appointments.push(a); else appointments[idx] = a;
      saveAppointments();
      renderAppointments();
      closeModal();
    });
    
    // Modal: Contextual Transfer (from Appointment list)
    function openTransferModal(index){
        const a = appointments[index];
        document.getElementById('transferIndex').value = index;
        document.getElementById('transferFirstName').value = a.firstName || '';
        document.getElementById('transferLastName').value = a.lastName || '';
        document.getElementById('transferRoom').value = a.room || '';
        document.getElementById('transferDate').value = a.date || '';
        document.getElementById('transferTime').value = a.time || '';
        document.getElementById('transferNotes').value = ''; // Reset notes field
        transferModal.style.display = 'block';
        document.getElementById('transferNotes').focus();
    }

    function closeTransferModal(){ transferModal.style.display = 'none' }

    transferForm.addEventListener('submit', e => {
        e.preventDefault();
        const t = {
            timestamp: new Date().toISOString(),
            firstName: document.getElementById('transferFirstName').value,
            lastName: document.getElementById('transferLastName').value,
            room: document.getElementById('transferRoom').value,
            date: document.getElementById('transferDate').value,
            time: document.getElementById('transferTime').value,
            notes: document.getElementById('transferNotes').value.trim() || 'Keine Notizen'
        };
        
        transfers.push(t); // Add to transfers array
        saveTransfers();
        renderTransfers();

        alert(`Transfer für ${t.firstName} ${t.lastName} erfolgreich gespeichert!`);
        closeTransferModal();
    });

    // NEW Modal: Add New Transfer (from Main controls)
    function openNewTransferModal(){
        newTransferForm.reset();
        document.getElementById('newTransferDate').value = todayISO();
        newTransferModal.style.display = 'block';
        document.getElementById('newTransferFirstName').focus();
    }

    function closeNewTransferModal(){ newTransferModal.style.display = 'none' }

    newTransferForm.addEventListener('submit', e => {
        e.preventDefault();
        const t = {
            timestamp: new Date().toISOString(),
            firstName: document.getElementById('newTransferFirstName').value.trim(),
            lastName: document.getElementById('newTransferLastName').value.trim(),
            room: document.getElementById('newTransferRoom').value.trim(),
            date: document.getElementById('newTransferDate').value,
            time: document.getElementById('newTransferTime').value,
            notes: document.getElementById('newTransferNotes').value.trim() || 'Keine Notizen'
        };
        
        transfers.push(t); // Add to transfers array
        saveTransfers();
        renderTransfers();

        alert(`Neuer Transfer für ${t.firstName} ${t.lastName} erfolgreich gespeichert!`);
        closeNewTransferModal();
    });


    // delete and utilities
    function deleteAppointment(i){
      if (!confirm('Diesen Termin wirklich löschen?')) return;
      appointments.splice(i,1);
      saveAppointments();
      renderAppointments();
    }
    function clearAll(){
      if (!confirm('Alle Termine löschen?')) return;
      appointments = [];
      saveAppointments();
      renderAppointments();
    }
    // NEW: Clear all transfers
    function clearAllTransfers(){
      if (!confirm('Alle Transfers löschen?')) return;
      transfers = [];
      saveTransfers();
      renderTransfers();
    }

    function exportJSON(){
      const dataStr = JSON.stringify({ appointments, transfers },null,2);
      const blob = new Blob([dataStr],{type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'drk_data.json'; document.body.appendChild(a); a.click();
      a.remove(); URL.revokeObjectURL(url);
    }

    window.addEventListener('load', () => {
      loadAppointments();
      loadTransfers(); // Load transfers on app start
    });

    // close modal by clicking outside
    window.addEventListener('click', e => {
      if (e.target === modal) closeModal();
      if (e.target === transferModal) closeTransferModal();
      if (e.target === newTransferModal) closeNewTransferModal(); // Close new transfer modal
    });
  </script>
</body>
</html>
